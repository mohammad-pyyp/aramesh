{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>بررسی نوبت‌ها — افزودن / ویرایش</title>

	<!-- Vazir font -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@27.0.1/dist/font-face.css">

	<style>
		:root {
			--accent: #06b6d4;
			--accent-light: rgba(6, 182, 212, 0.15);
			--muted: #94a3b8;
			--bg-card: rgba(255, 255, 255, 0.06);
		}

		* {
			box-sizing: border-box
		}

		body {
			font-family: 'Vazir', sans-serif;
			background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
			color: #e2e8f0;
			padding: 5px;
		}

		.calendar {
			background: var(--bg-card);
			padding: 20px;
			border-radius: 16px;
			max-width: 720px;
			margin: auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 12px;
		}

		.month {
			font-size: 18px;
			color: var(--accent);
			font-weight: 700;
			text-align: center;
		}

		button.icon {
			width: 36px;
			height: 36px;
			background: transparent;
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 10px;
			color: var(--muted);
			cursor: pointer;
		}

		button.icon:hover {
			color: var(--accent);
			border-color: var(--accent-light);
		}

		.weekdays,
		.grid {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			gap: 4px;
		}

		.weekdays div {
			text-align: center;
			font-size: 13px;
			color: var(--muted);
		}

		.cell {
			min-height: 50px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 8px;
			padding: 4px;
			cursor: pointer;
			position: relative;
		}

		.cell:hover {
			background: rgba(6, 182, 212, 0.07);
		}

		.cell.today {
			border: 1px solid var(--accent-light);
			background: rgba(6, 182, 212, 0.15);
		}

		.cell.holiday .date {
			color: #f87171;
		}

		.date {
			font-weight: 600;
			text-align: right;
		}

		/* marker for days with events */
		.dot {
			position: absolute;
			left: 6px;
			bottom: 6px;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--accent);
			box-shadow: 0 0 6px rgba(6, 182, 212, 0.6);
		}

		/* جدول */
		.table-section {
			max-width: 720px;
			margin: 20px auto;
		}

		.controls {
			display: flex;
			gap: 8px;
			margin-bottom: 12px;
			align-items: center;
		}

		.btn {
			padding: 6px 12px;
			border-radius: 8px;
			cursor: pointer;
			border: none;
			font-size: 13px;
		}

		.btn-primary {
			background: var(--accent);
			color: white;
		}

		.btn-ghost {
			background: rgba(255, 255, 255, 0.05);
			color: var(--muted);
		}

		.data-card {
			background: rgba(255, 255, 255, 0.03);
			padding: 12px;
			border-radius: 12px;
			overflow-x: auto;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			min-width: 250px;
		}

		th,
		td {
			padding: 8px;
			font-size: 13px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		th {
			color: var(--accent);
			text-align: right;
		}

		td {
			color: #dbeafe;
			vertical-align: middle;
		}

		.badge {
			padding: 4px 10px;
			border-radius: 999px;
			font-size: 12px;
			font-weight: 600;
			display: inline-block;
		}

		.pending {
			background: #fbbf24;
			color: #1f2937;
		}

		.confirmed {
			background: #34d399;
			color: #06202a;
		}

		.cancel {
			background: #fb7185;
			color: #1f2937;
		}

		/* modal */
		.overlay {
			position: fixed;
			inset: 0;
			background: rgba(2, 6, 23, 0.6);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 50;
		}

		.modal {
			background: #071027;
			border: 1px solid rgba(255, 255, 255, 0.06);
			padding: 18px;
			border-radius: 12px;
			width: 100%;
			max-width: 520px;
		}

		.form-row {
			display: flex;
			gap: 8px;
			margin-bottom: 10px;
		}

		.form-row input[type="text"],
		.form-row input[type="time"],
		.form-row select {
			flex: 1;
			padding: 8px 10px;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, 0.06);
			background: transparent;
			color: inherit;
		}

		label {
			display: block;
			font-size: 13px;
			margin-bottom: 6px;
			color: var(--muted);
		}

		.muted {
			color: var(--muted);
			font-size: 13px;
		}

		.danger {
			background: #ef4444;
			color: white;
			padding: 6px 10px;
			border-radius: 8px;
			cursor: pointer;
			border: none;
		}

		.btn-active,
		.btn-inactive {
			padding: 6px 12px;
			border-radius: 8px;
			font-size: 13px;
			cursor: pointer;
		}

		.btn-active {
			background: var(--accent);
			color: white;
		}

		.selected {
			/* background: linear-gradient(135deg, rgba(52, 211, 153, 0.9), rgba(16, 185, 129, 0.9)); */
			border: 1px solid rgba(52, 211, 153, 0.8);
			box-shadow: 0 0 12px rgba(52, 211, 153, 0.8);
			color: #fff;
			font-weight: bold;
			transition: all 0.25s ease-in-out;
			transform: scale(1.05);
		}



		@media (max-width:560px) {
			.form-row {
				flex-direction: column;
			}

			.weekdays div {
				font-size: 12px;
			}

			.cell {
				min-height: 44px;
			}
		}
	</style>
</head>

<body>

	<!-- تقویم -->
	<div class="calendar" x-data="jalaliCalendar()" x-init="init()"
		@appointments-updated.window="handleAppointmentsUpdated($event.detail)">
		<div class="header">
			<button class="icon" @click="prevMonth()">&lt;</button>
			<div class="month">
				<span x-text="monthTitle"></span>
				<small style="display:block; color:var(--muted);" x-text="toPersianDigits(year)"></small>
			</div>
			<button class="icon" @click="nextMonth()">&gt;</button>
		</div>

		<div class="weekdays">
			<template x-for="wd in weekdays">
				<div x-text="wd"></div>
			</template>
		</div>

		<div class="grid">
			<template x-for="(cell, idx) in grid" :key="idx">
				<div :class="{'cell':true,'empty':!cell.num,'today':cell.isToday,'holiday':cell.isHoliday ,'selected': cell.num && cell.num === selectedDay} "
					@click="cell.num && selectDay(cell.num)">
					<div class="date" x-text="cell.num ? toPersianDigits(cell.num) : ''"></div>
					<div class="dot" x-show="cell.hasEvent" x-cloak></div>
				</div>
			</template>
		</div>
	</div>

	<!-- جدول -->
	<div class="table-section" x-data="appointments()" x-init="init()"
		@day-selected.window="filterByDate($event.detail)"
		@appointments-updated.window="updateFromExternal($event.detail)">
		<div class="controls">
			<div style="display:flex; gap:8px;">
				<!-- <button class="btn btn-primary" @click="openNew()">+ افزودن نوبت</button> -->
				<button class="btn btn-ghost" @click="activeTable=1"
					:class="activeTable===1 ? 'btn-active':'btn-inactive'">📅 نوبت‌های روز انتخاب‌شده</button>
				<button class="btn btn-ghost" @click="activeTable=2"
					:class="activeTable===2 ? 'btn-active':'btn-inactive'">📌 نوبت‌های در حال بررسی</button>
			</div>
			<!-- <div style="margin-right:auto" class="muted">تاریخ انتخاب‌شده:
				<strong x-text="toPersianDigits(selectedDate)"></strong>
			</div> -->
		</div>

		<!-- جدول ۱ -->
		<div x-show="activeTable===1" x-transition>
			<div class="data-card">
				<table>
					<thead>
						<tr>
							<th>ساعت</th>
							<th>کاربر</th>
							<th>وضعیت</th>
							<!-- <th>عملیات</th> -->
						</tr>
					</thead>
					<tbody>
						<template x-for="(a,i) in filteredAppointments" :key="i">
							<tr>
								<td x-text="toPersianDigits(a.time)"></td>
								<td>
									<span x-text="a.user_fullname"></span>
								</td>
								<td><span class="badge" :class="a.status" x-text="statusText(a.status)"></span></td>
								<!-- <td>
									<button class="btn btn-ghost" @click="openEdit(i)">ویرایش</button>
								</td> -->
							</tr>
						</template>
						<tr x-show="filteredAppointments.length===0">
							<td colspan="5" class="muted" style="text-align:center">نوبتی برای این روز وجود ندارد.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- جدول ۲ -->
		<div x-show="activeTable===2" x-transition>
			<div class="data-card">
				<table>
					<thead>
						<tr>
							<th>کاربر</th>
							<th>وضعیت</th>
						</tr>
					</thead>
					<tbody>
						<template x-for="(a,i) in pendingAppointments" :key="i">
							<tr>
								<td x-text="a.user_fullname"></td>
								<td class="badge pending" x-text="statusText(a.status)"></td>
								<!-- <td><span >در انتظار</span></td> -->
								<!-- <td>
									<button class="btn btn-ghost" @click="openEditByGlobalIndex(a._idx)">ویرایش</button>
								</td> -->
							</tr>
						</template>
						<tr x-show="pendingAppointments.length===0">
							<td colspan="5" class="muted" style="text-align:center">نوبت در حال بررسی وجود ندارد.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- modal افزودن/ویرایش -->
		<div x-show="showModal" x-cloak class="overlay">
			<div class="modal" @click.outside="closeModal()" @keydown.escape.window="closeModal()">
				<h3 style="margin:0 0 12px;"> <span
						x-text="editingIndex===null ? 'افزودن نوبت جدید' : 'ویرایش نوبت'"></span>
				</h3>

				<div class="form-row" style="flex-direction:column;">
					<label>تاریخ (مثال: 1404/05/20)</label>
					<input type="text" x-model="form.date" placeholder="YYYY/MM/DD" />
				</div>

				<div class="form-row">
					<div style="flex:1">
						<label>ساعت</label>
						<input type="text" x-model="form.time" placeholder="مثال: 09:30" />
					</div>
					<div style="flex:1">
						<label>وضعیت</label>
						<select x-model="form.status">
							<option value="pending">در انتظار</option>
							<option value="confirmed">تایید شده</option>
							<option value="cancel">لغو شده</option>
						</select>
					</div>
				</div>

				<div class="form-row" style="flex-direction:column;">
					<label>عنوان</label>
					<input type="text" x-model="form.title" placeholder="مثال: جلسه تیم" />
				</div>

				<div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
					<button class="btn btn-primary" @click="save()">ذخیره</button>
					<button class="btn btn-ghost" @click="closeModal()">انصراف</button>
					<button x-show="editingIndex!==null" class="danger" @click="remove()">حذف</button>
				</div>

				<div style="margin-top:10px;" class="muted" x-show="error" x-text="error"></div>
			</div>
		</div>

	</div>


	<script src="{% static 'js/alpine.min.js' %}" defer></script>
	<script src="{% static 'js/jalaali.min.js' %}"></script>


	<script>
		/* ---------- تقویم ---------- */
		function jalaliCalendar() {
			return {
				year: null,
				month: null,
				monthTitle: '',
				weekdays: ['ش', 'ی', 'د', 'س', 'چ', 'پ', 'ج'],
				grid: [],
				markedDates: [],
				selectedDay: null,
				init() {
					const today = new Date();
					const j = jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
					this.year = j.jy; this.month = j.jm;
					this.build();
				},
				build() {
					const g = jalaali.toGregorian(this.year, this.month, 1);
					const first = new Date(g.gy, g.gm - 1, g.gd);
					const monthNames = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
					this.monthTitle = monthNames[this.month - 1];
					const monthLength = jalaali.jalaaliMonthLength(this.year, this.month);
					// convert JS weekday to our start (شنبه)
					const firstWeekday = (first.getDay() + 1) % 7;
					this.grid = [];
					for (let i = 0; i < firstWeekday; i++) this.grid.push({ num: null });
					const todayJ = jalaali.toJalaali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
					for (let d = 1; d <= monthLength; d++) {
						const isToday = (this.year === todayJ.jy && this.month === todayJ.jm && d === todayJ.jd);
						const g2 = jalaali.toGregorian(this.year, this.month, d);
						const isHoliday = new Date(g2.gy, g2.gm - 1, g2.gd).getDay() === 5;
						const dateStr = `${this.year}/${String(this.month).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
						const hasEvent = this.markedDates.includes(dateStr);
						this.grid.push({ num: d, isToday, isHoliday, hasEvent });
					}
					while (this.grid.length % 7 !== 0) this.grid.push({ num: null });
				},
				prevMonth() { if (this.month === 1) { this.month = 12; this.year--; } else this.month--; this.build(); },
				nextMonth() { if (this.month === 12) { this.month = 1; this.year++; } else this.month++; this.build(); },
				selectDay(day) {
					this.selectedDay = day;
					const dateStr = `${this.year}/${String(this.month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
					this.$dispatch('day-selected', dateStr);
				},
				toPersianDigits(n) {
					if (n === null || n === undefined) return '';
					const map = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
					return String(n).split('').map(c => map[c] || c).join('');
				},
				handleAppointmentsUpdated(dates) {
					// دریافت لیست تاریخ‌ها از کامپوننت دیگر
					this.markedDates = Array.isArray(dates) ? dates : [];
					this.build();
				}
			}
		}

		/* ---------- نوبت‌ها (appointments) ---------- */
		function appointments() {
			return {
				activeTable: 1,
				selectedDate: null,
				allAppointments: [],
				filteredAppointments: [], pendingAppointments: [],
				showModal: false, editingIndex: null,
				form: { date: '', time: '', title: '', status: 'pending' },
				error: '',
				storageKey: 'appointments_v1',

				init() {
					// بارگذاری از localStorage
					const raw = localStorage.getItem(this.storageKey);
					this.allAppointments = raw ? JSON.parse(raw) : [
						{ date: '1404/05/20', time: '10:30', user_fullname: "جعفر جعفری", status: 'confirmed' },
						{ date: '1404/05/20', time: '14:00', user_fullname: "علی علوی", status: 'cancel' },
						{ date: null        , time: '09:00', user_fullname: "محمد محمدی", status: 'pending' },
						{ date: '1404/05/25', time: '15:30', user_fullname: "رضا رضایی", status: 'confirmed' },
					];
					// اگر تقویم در ابتدای صفحه تاریخ امروز را فِراخوان کند، با آن هماهنگ شو
					const today = new Date();
					const j = jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
					this.selectedDate = `${j.jy}/${String(j.jm).padStart(2, '0')}/${String(j.jd).padStart(2, '0')}`;
					this.refreshDerived();
					// اعلام به تقویم (روزهایی که رویداد دارند)
					this.emitUpdatedDates();
				},

				/* helpers */
				toPersianDigits(n) { if (n === null || n === undefined) return ''; const map = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹']; return String(n).split('').map(c => map[c] || c).join(''); },
				statusText(s) { return s === 'confirmed' ? 'تایید شده' : s === 'pending' ? 'در انتظار' : 'لغو شده'; },

				refreshDerived() {
					// filteredAppointments بر اساس selectedDate
					this.filteredAppointments = this.allAppointments.filter(a => a.date === this.selectedDate);
					// pendingAppointments شامل همه نوبت‌های pending در کل مجموعه، با اندیس اصلی جهت ویرایش
					this.pendingAppointments = this.allAppointments
						.map((a, idx) => ({ ...a, _idx: idx }))
						.filter(a => a.status === 'pending');
				},

				filterByDate(date) {
					this.selectedDate = date;
					this.activeTable = 1;
					this.refreshDerived();
				},

				/* modal actions */
				openNew() {
					this.editingIndex = null;
					this.form = { date: this.selectedDate || '', time: '', title: '', status: 'pending' };
					this.error = '';
					this.showModal = true;
				},
				openEdit(localIndex) {
					// localIndex refers to index inside filteredAppointments
					const item = this.filteredAppointments[localIndex];
					if (!item) return;
					// find global index (may be multiple identical items — pick the one matching by reference)
					const gIdx = this.allAppointments.findIndex(a => a === item || (a.date === item.date && a.time === item.time && a.title === item.title));
					this.openEditByGlobalIndex(gIdx);
				},
				openEditByGlobalIndex(gIdx) {
					if (gIdx == null || gIdx < 0 || gIdx >= this.allAppointments.length) return;
					const item = this.allAppointments[gIdx];
					this.editingIndex = gIdx;
					this.form = { date: item.date, time: item.time, title: item.title, status: item.status };
					this.error = '';
					this.showModal = true;
				},
				closeModal() {
					this.showModal = false;
					this.error = '';
				},

				validateForm() {
					if (!this.form.date || !/^\d{4}\/\d{2}\/\d{2}$/.test(this.form.date)) { this.error = 'فرمت تاریخ باید مانند 1404/05/20 باشد.'; return false; }
					if (!this.form.time || !/^\d{1,2}:\d{2}$/.test(this.form.time)) { this.error = 'فرمت ساعت باید مانند 09:30 باشد.'; return false; }
					if (!this.form.title || this.form.title.trim().length < 2) { this.error = 'عنوان باید حداقل ۲ حرف باشد.'; return false; }
					return true;
				},

				save() {
					if (!this.validateForm()) return;
					const payload = { date: this.form.date, time: this.form.time, title: this.form.title.trim(), status: this.form.status };
					if (this.editingIndex === null) {
						// افزودن
						this.allAppointments.push(payload);
					} else {
						// ویرایش
						this.allAppointments.splice(this.editingIndex, 1, payload);
					}
					// persist
					localStorage.setItem(this.storageKey, JSON.stringify(this.allAppointments));
					this.refreshDerived();
					this.emitUpdatedDates();
					this.closeModal();
				},

				remove() {
					if (this.editingIndex === null) return;
					if (!confirm('آیا مطمئن هستید که این نوبت حذف شود؟')) return;
					this.allAppointments.splice(this.editingIndex, 1);
					localStorage.setItem(this.storageKey, JSON.stringify(this.allAppointments));
					this.refreshDerived();
					this.emitUpdatedDates();
					this.closeModal();
				},

				emitUpdatedDates() {
					// ساخت آرایهٔ تاریخ‌های یکتا که نوبت دارند
					const dates = Array.from(new Set(this.allAppointments.map(a => a.date)));
					// انتشار رویداد سراسری (تقویم گوش میده)
					window.dispatchEvent(new CustomEvent('appointments-updated', { detail: dates }));
				},

				/* زمانی که تقویم یا دیگران ایونت ارسال کنند */
				updateFromExternal(detail) {
					// اگر تقویم یا مابع دیگر تغییر داده، دوباره رفرش کن
					this.refreshDerived();
				}
			}
		}
	</script>
</body>

</html>