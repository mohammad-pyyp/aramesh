{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ â€” Ø§ÙØ²ÙˆØ¯Ù† / ÙˆÛŒØ±Ø§ÛŒØ´</title>

	<!-- Vazir font -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@27.0.1/dist/font-face.css">

	<style>
		:root {
			--accent: #06b6d4;
			--accent-light: rgba(6, 182, 212, 0.15);
			--muted: #94a3b8;
			--bg-card: rgba(255, 255, 255, 0.06);
		}

		* {
			box-sizing: border-box
		}

		body {
			font-family: 'Vazir', sans-serif;
			background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
			color: #e2e8f0;
			padding: 5px;
		}

		.calendar {
			background: var(--bg-card);
			padding: 20px;
			border-radius: 16px;
			max-width: 720px;
			margin: auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 12px;
		}

		.month {
			font-size: 18px;
			color: var(--accent);
			font-weight: 700;
			text-align: center;
		}

		button.icon {
			width: 36px;
			height: 36px;
			background: transparent;
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 10px;
			color: var(--muted);
			cursor: pointer;
		}

		button.icon:hover {
			color: var(--accent);
			border-color: var(--accent-light);
		}

		.weekdays,
		.grid {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			gap: 4px;
		}

		.weekdays div {
			text-align: center;
			font-size: 13px;
			color: var(--muted);
		}

		.cell {
			min-height: 50px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 8px;
			padding: 4px;
			cursor: pointer;
			position: relative;
		}

		.cell:hover {
			background: rgba(6, 182, 212, 0.07);
		}

		.cell.today {
			border: 1px solid var(--accent-light);
			background: rgba(6, 182, 212, 0.15);
		}

		.cell.holiday .date {
			color: #f87171;
		}

		.date {
			font-weight: 600;
			text-align: right;
		}

		/* marker for days with events */
		.dot {
			position: absolute;
			left: 6px;
			bottom: 6px;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--accent);
			box-shadow: 0 0 6px rgba(6, 182, 212, 0.6);
		}

		/* Ø¬Ø¯ÙˆÙ„ */
		.table-section {
			max-width: 720px;
			margin: 20px auto;
		}

		.controls {
			display: flex;
			gap: 8px;
			margin-bottom: 12px;
			align-items: center;
		}

		.btn {
			padding: 6px 12px;
			border-radius: 8px;
			cursor: pointer;
			border: none;
			font-size: 13px;
		}

		.btn-primary {
			background: var(--accent);
			color: white;
		}

		.btn-ghost {
			background: rgba(255, 255, 255, 0.05);
			color: var(--muted);
		}

		.data-card {
			background: rgba(255, 255, 255, 0.03);
			padding: 12px;
			border-radius: 12px;
			overflow-x: auto;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			min-width: 250px;
		}

		th,
		td {
			padding: 8px;
			font-size: 13px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		th {
			color: var(--accent);
			text-align: right;
		}

		td {
			color: #dbeafe;
			vertical-align: middle;
		}

		.badge {
			padding: 4px 10px;
			border-radius: 999px;
			font-size: 12px;
			font-weight: 600;
			display: inline-block;
		}

		.pending {
			background: #fbbf24;
			color: #1f2937;
		}

		.confirmed {
			background: #34d399;
			color: #06202a;
		}

		.cancel {
			background: #fb7185;
			color: #1f2937;
		}

		/* modal */
		.overlay {
			position: fixed;
			inset: 0;
			background: rgba(2, 6, 23, 0.6);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 50;
		}

		.modal {
			background: #071027;
			border: 1px solid rgba(255, 255, 255, 0.06);
			padding: 18px;
			border-radius: 12px;
			width: 100%;
			max-width: 520px;
		}

		.form-row {
			display: flex;
			gap: 8px;
			margin-bottom: 10px;
		}

		.form-row input[type="text"],
		.form-row input[type="time"],
		.form-row select {
			flex: 1;
			padding: 8px 10px;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, 0.06);
			background: transparent;
			color: inherit;
		}

		label {
			display: block;
			font-size: 13px;
			margin-bottom: 6px;
			color: var(--muted);
		}

		.muted {
			color: var(--muted);
			font-size: 13px;
		}

		.danger {
			background: #ef4444;
			color: white;
			padding: 6px 10px;
			border-radius: 8px;
			cursor: pointer;
			border: none;
		}

		.btn-active,
		.btn-inactive {
			padding: 6px 12px;
			border-radius: 8px;
			font-size: 13px;
			cursor: pointer;
		}

		.btn-active {
			background: var(--accent);
			color: white;
		}

		.selected {
			/* background: linear-gradient(135deg, rgba(52, 211, 153, 0.9), rgba(16, 185, 129, 0.9)); */
			border: 1px solid rgba(52, 211, 153, 0.8);
			box-shadow: 0 0 12px rgba(52, 211, 153, 0.8);
			color: #fff;
			font-weight: bold;
			transition: all 0.25s ease-in-out;
			transform: scale(1.05);
		}



		@media (max-width:560px) {
			.form-row {
				flex-direction: column;
			}

			.weekdays div {
				font-size: 12px;
			}

			.cell {
				min-height: 44px;
			}
		}
	</style>
</head>

<body>

	<!-- ØªÙ‚ÙˆÛŒÙ… -->
	<div class="calendar" x-data="jalaliCalendar()" x-init="init()"
		@appointments-updated.window="handleAppointmentsUpdated($event.detail)">
		<div class="header">
			<button class="icon" @click="prevMonth()">&lt;</button>
			<div class="month">
				<span x-text="monthTitle"></span>
				<small style="display:block; color:var(--muted);" x-text="toPersianDigits(year)"></small>
			</div>
			<button class="icon" @click="nextMonth()">&gt;</button>
		</div>

		<div class="weekdays">
			<template x-for="wd in weekdays">
				<div x-text="wd"></div>
			</template>
		</div>

		<div class="grid">
			<template x-for="(cell, idx) in grid" :key="idx">
				<div :class="{'cell':true,'empty':!cell.num,'today':cell.isToday,'holiday':cell.isHoliday ,'selected': cell.num && cell.num === selectedDay} "
					@click="cell.num && selectDay(cell.num)">
					<div class="date" x-text="cell.num ? toPersianDigits(cell.num) : ''"></div>
					<div class="dot" x-show="cell.hasEvent" x-cloak></div>
				</div>
			</template>
		</div>
	</div>

	<!-- Ø¬Ø¯ÙˆÙ„ -->
	<div class="table-section" x-data="appointments()" x-init="init()"
		@day-selected.window="filterByDate($event.detail)"
		@appointments-updated.window="updateFromExternal($event.detail)">
		<div class="controls">
			<div style="display:flex; gap:8px;">
				<!-- <button class="btn btn-primary" @click="openNew()">+ Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙˆØ¨Øª</button> -->
				<button class="btn btn-ghost" @click="activeTable=1"
					:class="activeTable===1 ? 'btn-active':'btn-inactive'">ğŸ“… Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button>
				<button class="btn btn-ghost" @click="activeTable=2"
					:class="activeTable===2 ? 'btn-active':'btn-inactive'">ğŸ“Œ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ</button>
			</div>
			<!-- <div style="margin-right:auto" class="muted">ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡:
				<strong x-text="toPersianDigits(selectedDate)"></strong>
			</div> -->
		</div>

		<!-- Ø¬Ø¯ÙˆÙ„ Û± -->
		<div x-show="activeTable===1" x-transition>
			<div class="data-card">
				<table>
					<thead>
						<tr>
							<th>Ø³Ø§Ø¹Øª</th>
							<th>Ú©Ø§Ø±Ø¨Ø±</th>
							<th>ÙˆØ¶Ø¹ÛŒØª</th>
							<!-- <th>Ø¹Ù…Ù„ÛŒØ§Øª</th> -->
						</tr>
					</thead>
					<tbody>
						<template x-for="(a,i) in filteredAppointments" :key="i">
							<tr>
								<td x-text="toPersianDigits(a.time)"></td>
								<td>
									<span x-text="a.user_fullname"></span>
								</td>
								<td><span class="badge" :class="a.status" x-text="statusText(a.status)"></span></td>
								<!-- <td>
									<button class="btn btn-ghost" @click="openEdit(i)">ÙˆÛŒØ±Ø§ÛŒØ´</button>
								</td> -->
							</tr>
						</template>
						<tr x-show="filteredAppointments.length===0">
							<td colspan="5" class="muted" style="text-align:center">Ù†ÙˆØ¨ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ² ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- Ø¬Ø¯ÙˆÙ„ Û² -->
		<div x-show="activeTable===2" x-transition>
			<div class="data-card">
				<table>
					<thead>
						<tr>
							<th>Ú©Ø§Ø±Ø¨Ø±</th>
							<th>ÙˆØ¶Ø¹ÛŒØª</th>
						</tr>
					</thead>
					<tbody>
						<template x-for="(a,i) in pendingAppointments" :key="i">
							<tr>
								<td x-text="a.user_fullname"></td>
								<td class="badge pending" x-text="statusText(a.status)"></td>
								<!-- <td><span >Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span></td> -->
								<!-- <td>
									<button class="btn btn-ghost" @click="openEditByGlobalIndex(a._idx)">ÙˆÛŒØ±Ø§ÛŒØ´</button>
								</td> -->
							</tr>
						</template>
						<tr x-show="pendingAppointments.length===0">
							<td colspan="5" class="muted" style="text-align:center">Ù†ÙˆØ¨Øª Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- modal Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ -->
		<div x-show="showModal" x-cloak class="overlay">
			<div class="modal" @click.outside="closeModal()" @keydown.escape.window="closeModal()">
				<h3 style="margin:0 0 12px;"> <span
						x-text="editingIndex===null ? 'Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯' : 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÙˆØ¨Øª'"></span>
				</h3>

				<div class="form-row" style="flex-direction:column;">
					<label>ØªØ§Ø±ÛŒØ® (Ù…Ø«Ø§Ù„: 1404/05/20)</label>
					<input type="text" x-model="form.date" placeholder="YYYY/MM/DD" />
				</div>

				<div class="form-row">
					<div style="flex:1">
						<label>Ø³Ø§Ø¹Øª</label>
						<input type="text" x-model="form.time" placeholder="Ù…Ø«Ø§Ù„: 09:30" />
					</div>
					<div style="flex:1">
						<label>ÙˆØ¶Ø¹ÛŒØª</label>
						<select x-model="form.status">
							<option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
							<option value="confirmed">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</option>
							<option value="cancel">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
						</select>
					</div>
				</div>

				<div class="form-row" style="flex-direction:column;">
					<label>Ø¹Ù†ÙˆØ§Ù†</label>
					<input type="text" x-model="form.title" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ù„Ø³Ù‡ ØªÛŒÙ…" />
				</div>

				<div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
					<button class="btn btn-primary" @click="save()">Ø°Ø®ÛŒØ±Ù‡</button>
					<button class="btn btn-ghost" @click="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
					<button x-show="editingIndex!==null" class="danger" @click="remove()">Ø­Ø°Ù</button>
				</div>

				<div style="margin-top:10px;" class="muted" x-show="error" x-text="error"></div>
			</div>
		</div>

	</div>


	<script src="{% static 'js/alpine.min.js' %}" defer></script>
	<script src="{% static 'js/jalaali.min.js' %}"></script>


	<script>
		/* ---------- ØªÙ‚ÙˆÛŒÙ… ---------- */
		function jalaliCalendar() {
			return {
				year: null,
				month: null,
				monthTitle: '',
				weekdays: ['Ø´', 'ÛŒ', 'Ø¯', 'Ø³', 'Ú†', 'Ù¾', 'Ø¬'],
				grid: [],
				markedDates: [],
				selectedDay: null,
				init() {
					const today = new Date();
					const j = jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
					this.year = j.jy; this.month = j.jm;
					this.build();
				},
				build() {
					const g = jalaali.toGregorian(this.year, this.month, 1);
					const first = new Date(g.gy, g.gm - 1, g.gd);
					const monthNames = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±', 'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'];
					this.monthTitle = monthNames[this.month - 1];
					const monthLength = jalaali.jalaaliMonthLength(this.year, this.month);
					// convert JS weekday to our start (Ø´Ù†Ø¨Ù‡)
					const firstWeekday = (first.getDay() + 1) % 7;
					this.grid = [];
					for (let i = 0; i < firstWeekday; i++) this.grid.push({ num: null });
					const todayJ = jalaali.toJalaali(new Date().getFullYear(), new Date().getMonth() + 1, new Date().getDate());
					for (let d = 1; d <= monthLength; d++) {
						const isToday = (this.year === todayJ.jy && this.month === todayJ.jm && d === todayJ.jd);
						const g2 = jalaali.toGregorian(this.year, this.month, d);
						const isHoliday = new Date(g2.gy, g2.gm - 1, g2.gd).getDay() === 5;
						const dateStr = `${this.year}/${String(this.month).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
						const hasEvent = this.markedDates.includes(dateStr);
						this.grid.push({ num: d, isToday, isHoliday, hasEvent });
					}
					while (this.grid.length % 7 !== 0) this.grid.push({ num: null });
				},
				prevMonth() { if (this.month === 1) { this.month = 12; this.year--; } else this.month--; this.build(); },
				nextMonth() { if (this.month === 12) { this.month = 1; this.year++; } else this.month++; this.build(); },
				selectDay(day) {
					this.selectedDay = day;
					const dateStr = `${this.year}/${String(this.month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
					this.$dispatch('day-selected', dateStr);
				},
				toPersianDigits(n) {
					if (n === null || n === undefined) return '';
					const map = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
					return String(n).split('').map(c => map[c] || c).join('');
				},
				handleAppointmentsUpdated(dates) {
					// Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ Ø§Ø² Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Ø¯ÛŒÚ¯Ø±
					this.markedDates = Array.isArray(dates) ? dates : [];
					this.build();
				}
			}
		}

		/* ---------- Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ (appointments) ---------- */
		function appointments() {
			return {
				activeTable: 1,
				selectedDate: null,
				allAppointments: [],
				filteredAppointments: [], pendingAppointments: [],
				showModal: false, editingIndex: null,
				form: { date: '', time: '', title: '', status: 'pending' },
				error: '',
				storageKey: 'appointments_v1',

				init() {
					// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² localStorage
					const raw = localStorage.getItem(this.storageKey);
					this.allAppointments = raw ? JSON.parse(raw) : [
						{ date: '1404/05/20', time: '10:30', user_fullname: "Ø¬Ø¹ÙØ± Ø¬Ø¹ÙØ±ÛŒ", status: 'confirmed' },
						{ date: '1404/05/20', time: '14:00', user_fullname: "Ø¹Ù„ÛŒ Ø¹Ù„ÙˆÛŒ", status: 'cancel' },
						{ date: null        , time: '09:00', user_fullname: "Ù…Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ÛŒ", status: 'pending' },
						{ date: '1404/05/25', time: '15:30', user_fullname: "Ø±Ø¶Ø§ Ø±Ø¶Ø§ÛŒÛŒ", status: 'confirmed' },
					];
					// Ø§Ú¯Ø± ØªÙ‚ÙˆÛŒÙ… Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ ØµÙØ­Ù‡ ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø±Ø§ ÙÙØ±Ø§Ø®ÙˆØ§Ù† Ú©Ù†Ø¯ØŒ Ø¨Ø§ Ø¢Ù† Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø´Ùˆ
					const today = new Date();
					const j = jalaali.toJalaali(today.getFullYear(), today.getMonth() + 1, today.getDate());
					this.selectedDate = `${j.jy}/${String(j.jm).padStart(2, '0')}/${String(j.jd).padStart(2, '0')}`;
					this.refreshDerived();
					// Ø§Ø¹Ù„Ø§Ù… Ø¨Ù‡ ØªÙ‚ÙˆÛŒÙ… (Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ø§Ø±Ù†Ø¯)
					this.emitUpdatedDates();
				},

				/* helpers */
				toPersianDigits(n) { if (n === null || n === undefined) return ''; const map = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹']; return String(n).split('').map(c => map[c] || c).join(''); },
				statusText(s) { return s === 'confirmed' ? 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡' : s === 'pending' ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±' : 'Ù„ØºÙˆ Ø´Ø¯Ù‡'; },

				refreshDerived() {
					// filteredAppointments Ø¨Ø± Ø§Ø³Ø§Ø³ selectedDate
					this.filteredAppointments = this.allAppointments.filter(a => a.date === this.selectedDate);
					// pendingAppointments Ø´Ø§Ù…Ù„ Ù‡Ù…Ù‡ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ pending Ø¯Ø± Ú©Ù„ Ù…Ø¬Ù…ÙˆØ¹Ù‡ØŒ Ø¨Ø§ Ø§Ù†Ø¯ÛŒØ³ Ø§ØµÙ„ÛŒ Ø¬Ù‡Øª ÙˆÛŒØ±Ø§ÛŒØ´
					this.pendingAppointments = this.allAppointments
						.map((a, idx) => ({ ...a, _idx: idx }))
						.filter(a => a.status === 'pending');
				},

				filterByDate(date) {
					this.selectedDate = date;
					this.activeTable = 1;
					this.refreshDerived();
				},

				/* modal actions */
				openNew() {
					this.editingIndex = null;
					this.form = { date: this.selectedDate || '', time: '', title: '', status: 'pending' };
					this.error = '';
					this.showModal = true;
				},
				openEdit(localIndex) {
					// localIndex refers to index inside filteredAppointments
					const item = this.filteredAppointments[localIndex];
					if (!item) return;
					// find global index (may be multiple identical items â€” pick the one matching by reference)
					const gIdx = this.allAppointments.findIndex(a => a === item || (a.date === item.date && a.time === item.time && a.title === item.title));
					this.openEditByGlobalIndex(gIdx);
				},
				openEditByGlobalIndex(gIdx) {
					if (gIdx == null || gIdx < 0 || gIdx >= this.allAppointments.length) return;
					const item = this.allAppointments[gIdx];
					this.editingIndex = gIdx;
					this.form = { date: item.date, time: item.time, title: item.title, status: item.status };
					this.error = '';
					this.showModal = true;
				},
				closeModal() {
					this.showModal = false;
					this.error = '';
				},

				validateForm() {
					if (!this.form.date || !/^\d{4}\/\d{2}\/\d{2}$/.test(this.form.date)) { this.error = 'ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø¨Ø§ÛŒØ¯ Ù…Ø§Ù†Ù†Ø¯ 1404/05/20 Ø¨Ø§Ø´Ø¯.'; return false; }
					if (!this.form.time || !/^\d{1,2}:\d{2}$/.test(this.form.time)) { this.error = 'ÙØ±Ù…Øª Ø³Ø§Ø¹Øª Ø¨Ø§ÛŒØ¯ Ù…Ø§Ù†Ù†Ø¯ 09:30 Ø¨Ø§Ø´Ø¯.'; return false; }
					if (!this.form.title || this.form.title.trim().length < 2) { this.error = 'Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û² Ø­Ø±Ù Ø¨Ø§Ø´Ø¯.'; return false; }
					return true;
				},

				save() {
					if (!this.validateForm()) return;
					const payload = { date: this.form.date, time: this.form.time, title: this.form.title.trim(), status: this.form.status };
					if (this.editingIndex === null) {
						// Ø§ÙØ²ÙˆØ¯Ù†
						this.allAppointments.push(payload);
					} else {
						// ÙˆÛŒØ±Ø§ÛŒØ´
						this.allAppointments.splice(this.editingIndex, 1, payload);
					}
					// persist
					localStorage.setItem(this.storageKey, JSON.stringify(this.allAppointments));
					this.refreshDerived();
					this.emitUpdatedDates();
					this.closeModal();
				},

				remove() {
					if (this.editingIndex === null) return;
					if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø§ÛŒÙ† Ù†ÙˆØ¨Øª Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
					this.allAppointments.splice(this.editingIndex, 1);
					localStorage.setItem(this.storageKey, JSON.stringify(this.allAppointments));
					this.refreshDerived();
					this.emitUpdatedDates();
					this.closeModal();
				},

				emitUpdatedDates() {
					// Ø³Ø§Ø®Øª Ø¢Ø±Ø§ÛŒÙ‡Ù” ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ ÛŒÚ©ØªØ§ Ú©Ù‡ Ù†ÙˆØ¨Øª Ø¯Ø§Ø±Ù†Ø¯
					const dates = Array.from(new Set(this.allAppointments.map(a => a.date)));
					// Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø³Ø±Ø§Ø³Ø±ÛŒ (ØªÙ‚ÙˆÛŒÙ… Ú¯ÙˆØ´ Ù…ÛŒØ¯Ù‡)
					window.dispatchEvent(new CustomEvent('appointments-updated', { detail: dates }));
				},

				/* Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ ØªÙ‚ÙˆÛŒÙ… ÛŒØ§ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø§ÛŒÙˆÙ†Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ù†Ø¯ */
				updateFromExternal(detail) {
					// Ø§Ú¯Ø± ØªÙ‚ÙˆÛŒÙ… ÛŒØ§ Ù…Ø§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙØ±Ø´ Ú©Ù†
					this.refreshDerived();
				}
			}
		}
	</script>
</body>

</html>